<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Acceso - Parking Login</title>
    <link rel="stylesheet" href="../css/styles.css" />
  </head>
  <body>
    <div class="login-container">
      <div id="login-card" class="login-card">
        <div class="login-header">
          <img src="../assets/logo-login.png" alt="Logo" class="logo" />
          <h2>Bienvenido</h2>
          <p>Ingrese sus credenciales</p>
        </div>
        <form id="login-form">
          <div class="input-group">
            <label>Usuario</label>
            <input
              type="text"
              id="username"
              placeholder="ej. admin_temporal"
              required
            />
          </div>
          <div class="input-group">
            <label>Contrase√±a</label>
            <input
              type="password"
              id="password"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
            />
          </div>
          <button type="submit" class="btn-login">Ingresar</button>
        </form>
      </div>

     <div
        id="unlock-card"
        class="login-card"
        style="display: none; text-align: center"
      >
        <div class="login-header" style="display: flex; flex-direction: column; align-items: center;">
          <div style="font-size: 3rem; margin-bottom: 10px">üîê</div>
          <h3 style="color: #334155; margin: 0; text-align: center">Sesi√≥n Bloqueada</h3>
          <p style="text-align: center">Ingrese su contrase√±a para continuar</p>
        </div>

        <div
          style="
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #cbd5e1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
          "
        >
          <small
            style="color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;"
            >Usuario Activo</small
          >
          <h3 id="locked-user-name" style="margin: 8px auto; color: #0f172a; width: 100%; text-align: center; display: block;">
            ...
          </h3>
          <div style="background: #e2e8f0; padding: 2px 10px; border-radius: 12px;">
             <small id="locked-user-username" style="color: #475569; font-family: monospace; font-size: 0.9rem;">...</small>
          </div>
        </div>

        <form id="unlock-form">
          <div class="input-group" style="text-align: left">
            <label>Contrase√±a</label>
            <input
              type="password"
              id="unlock-password"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
              autofocus
            />
          </div>
          <button
            type="submit"
            class="btn-login"
            style="background-color: #f59e0b"
          >
            üîì Desbloquear
          </button>
        </form>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #e2e8f0" />

        <button
          onclick="cerrarSesionCompleta()"
          style="
            background: none;
            border: none;
            color: #ef4444;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: underline;
          "
        >
          No soy este usuario (Cerrar Sesi√≥n)
        </button>
      </div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #e2e8f0" />

        <button
          onclick="cerrarSesionCompleta()"
          style="
            background: none;
            border: none;
            color: #ef4444;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: underline;
          "
        >
        </button>
      </div>
    </div>

    <script>
      const API_URL = "http://127.0.0.1:3000/api/auth/login";


      document.addEventListener("DOMContentLoaded", () => {
        const isLocked = localStorage.getItem("sesionBloqueada") === "true";
        const nombre = localStorage.getItem("usuarioNombre");
        const username = localStorage.getItem("usuarioUser");

        if (isLocked && nombre && username) {
          mostrarDesbloqueo(nombre, username);
        } else {
          localStorage.removeItem("sesionBloqueada");
          document.getElementById("login-card").style.display = "block";
          document.getElementById("unlock-card").style.display = "none";
        }
      });

      function mostrarDesbloqueo(nombre, username) {
        document.getElementById("login-card").style.display = "none";
        document.getElementById("unlock-card").style.display = "block";

        document.getElementById("locked-user-name").innerText = nombre;
        document.getElementById("locked-user-username").innerText = username;

        setTimeout(
          () => document.getElementById("unlock-password").focus(),
          100,
        );
      }

      function cerrarSesionCompleta() {
    if (confirm("‚ö†Ô∏è ¬øDesea realizar el CORTE X (Reporte de Turno) antes de cambiar de usuario?")) {

        window.location.href = "dashboard.html?forceCorteX=true";
    }
}

      document
        .getElementById("login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const u = document.getElementById("username").value;
          const p = document.getElementById("password").value;
          await autenticar(u, p, false);
        });

      document
        .getElementById("unlock-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const u = localStorage.getItem("usuarioUser");
          const p = document.getElementById("unlock-password").value;
          await autenticar(u, p, true);
        });

      async function autenticar(username, password, esDesbloqueo) {
        try {
          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });

          const data = await res.json();

          if (res.ok) {
            const u = data.usuario;

            localStorage.setItem("usuarioId", u.id || u.ID_USUARIO);
            localStorage.setItem(
              "usuarioNombre",
              u.nombre || u.NOMBRE_EMPLEADO,
            );
            localStorage.setItem("usuarioUser", username);
            localStorage.setItem("usuarioRol", u.rol || u.ROL);

            if (!esDesbloqueo) {
              localStorage.setItem("inicioTurno", new Date().toISOString());
            }

            localStorage.removeItem("sesionBloqueada");

            window.location.href = "dashboard.html";
          } else {
            alert("‚ùå Contrase√±a incorrecta");
            if (esDesbloqueo)
              document.getElementById("unlock-password").value = "";
          }
        } catch (error) {
          console.error(error);
          alert("‚ùå Error de conexi√≥n");
        }
      }
    </script>
  </body>
</html>
